# Original automation disabled - now using LLM verification
# - id: "1724842623807"
#   alias: "MouseCamera notifications "
#   description: "Imou 5se cam "
#   use_blueprint:
#     path: SgtBatten/Stable.yaml
#     input:
#       camera: camera.mousecam
#       notify_device: f326594e961a48756bccbda5b2185cd2
#       base_url: !secret external_base_url
#       title: MouseCam1
#       labels:
#         - mouse
#         - mice
#         - rat
#       debug: true
#       message: "Mus detecterad \U0001F631"
- id: "mouse_verification_automation"
  alias: "Mouse Detection with LLM Verification"
  description: "Captures camera image and verifies with LLM before sending notification"
  trigger:
    - platform: mqtt
      topic: frigate_asuspc_mousecam/events
      payload: "mousecam/new"
      value_template: '{{ value_json["after"]["camera"] | lower | replace("-","_") }}/{{ value_json["type"]}}'
  action:
    - variables:
        base_url: !secret external_base_url
        # Debug mode: use test event ID when trigger data is not available
        event_id: >-
          {% if trigger.payload_json is defined and trigger.payload_json["after"]["id"] is defined %}
            {{ trigger.payload_json["after"]["id"] }}
          {% else %}
            debug_test_{{ now().strftime('%Y%m%d_%H%M%S') }}
          {% endif %}
    - service: camera.snapshot
      target:
        entity_id: camera.mousecam
      data:
        filename: "/config/www/mouse_verification_{{ event_id }}.jpg"
    - delay:
        seconds: 2
    - service: extended_openai_conversation.query_image
      data:
        config_entry: !secret openai_config_entry
        model: "gpt-4o-mini"
        prompt: "Look at this image from a security camera. Is there a mouse, rat, or similar small rodent visible in the image? Answer with only 'YES' if you can clearly see a mouse/rat, or 'NO' if you cannot see a mouse/rat or if you see something else like a spider, insect, or other object."
        images:
          - url: "{{ base_url }}/local/mouse_verification_{{ event_id }}.jpg"
        max_tokens: 10
      response_variable: llm_response
    - choose:
        - conditions:
            - condition: template
              value_template: '{{ llm_response.choices[0].message.content | upper == "YES" }}'
          sequence:
            - service: notify.Anders
              data:
                title: "Mouse Detected - Verified by AI"
                message: "Mus verifierad av AI \U0001F631"
                data:
                  image: "{{ base_url }}/local/mouse_verification_{{ event_id }}.jpg"
                  tag: "mouse_verified_{{ event_id }}"
                  clickAction: "{{ base_url }}/api/frigate/notifications/{{ event_id }}/snapshot.jpg"
            - service: logbook.log
              data:
                name: Mouse Detection
                message: "Mouse verified by LLM - Event ID: {{ event_id }}"
        - conditions:
            - condition: template
              value_template: '{{ llm_response.choices[0].message.content | upper == "NO" }}'
          sequence:
            - service: logbook.log
              data:
                name: Mouse Detection
                message: "False positive filtered by LLM - Event ID: {{ event_id }} - Response: {{ llm_response.choices[0].message.content }}"
    - service: shell_command.remove_file
      data:
        path: "/config/www/mouse_verification_{{ event_id }}.jpg"
- id: Frigate_rpi3_camera
  alias: Alarm - Tapo C310 notify
  description: Frigate Notifications (0.12.0.2)
  use_blueprint:
    path: SgtBatten/Stable.yaml
    input:
      camera: camera.tapo_c310
      notify_device: f326594e961a48756bccbda5b2185cd2
      alert_once: true
      attachment: thumbnail
      debug: false
      message: "{{ label }} detected - {{ camera_name }}"
      title: "{{camera_name}} {{ label}} "
      color: steelblue
      channel: Frigate
      update_thumbnail: true
      labels: []
      icon: mdi:cctv
      state_entity: lock.ytterdorr
      state_filter_states:
        - locked
      presence_filter: person.anders
      state_filter: true
      base_url: !secret external_base_url
- id: disarm_on_unlock
  alias: Larma av vid upplåsning
  description: Disarma alarmet när 'lock.ytterdorr' låses upp
  triggers:
    - trigger: state
      entity_id:
        - lock.ytterdorr
      from: locked
      to: unlocked
  conditions:
    - condition: device
      device_id: c9dccef4072dbf886ab56405179875f5
      domain: alarm_control_panel
      entity_id: 66d4dd5165a0c22f37f0ee87d6c1ff50
      type: is_armed_home
  actions:
    - action: alarm_control_panel.alarm_disarm
      data:
        code: !secret verisure_code
      target:
        entity_id: alarm_control_panel.verisure_alarm
  mode: single
