###############################################################################
# Nibe F1145 Package
#
#
###############################################################################

template:
  - sensor:
    - name: "Nibe ΔT (BT2-BT3)"
      unique_id: nibe_delta_t_bt
      unit_of_measurement: "°C"
      state_class: measurement
      device_class: temperature
      state: >
        {% set bt2 = states('sensor.nibe_f1145_bt2_supply_temp_s1')|float(0) %}
        {% set bt3 = states('sensor.nibe_f1145_eb100_ep14_bt3_return_temp')|float(0) %}
        {{ (bt2 - bt3) | round(1) }}

script:
  nibe_alarm_lookup:
    alias: "Nibe – översätt larmkod"
    description: Returnerar titel, beskrivning och severity för en Nibe-larmkod.
    mode: single
    fields:
      alarm_code:
        description: Larmkod från Nibe (t.ex. 55)
        example: 55
    sequence:
      - variables:
          alarms:
            code-1:
              title: Sensor fault BT1
              description: >-
                Sensor not connected/defective. Calculated flow temperature is set
                to minimum calculated flow temperature.
              severity: critical
            code-2:
              title: Sensor fault BT2
              description: >-
                Sensor not connected/defective (heating medium return). Addition
                blocked. GM is calculated with 'condenser out' sensor; heating
                blocked if this is also missing.
              severity: critical
            code-3:
              title: Sensor fault BT3
              description: >-
                Sensor not connected/defective (heating medium return). Compressor
                blocked during hot water loading.
              severity: critical
            code-6:
              title: Sensor fault BT6
              description: >-
                Sensor not connected/defective (hot water controlling). Automatic
                reset.
              severity: warning
            code-7:
              title: Sensor fault BT7
              description: Sensor not connected/defective (hot water peak). Automatic reset.
              severity: warning
            code-10:
              title: Sensor fault BT10
              description: >-
                Sensor not connected/defective (brine in). Brine pump GP2 switches
                to manual speed if auto-control is selected. Automatic reset after
                60 s normal operation.
              severity: warning
            code-11:
              title: Sensor fault BT11
              description: Sensor not connected/defective (condenser out). Compressor blocked.
              severity: critical
            code-12:
              title: Sensor fault BT12
              description: >-
                Sensor not connected/defective (condenser return). BT2 is used for
                max condenser out control; if BT2 also missing: heating mode and
                compressor in HW mode are blocked.
              severity: critical
            code-16:
              title: Sensor fault BT16
              description: Sensor not connected/defective (evaporator). Automatic reset.
              severity: warning
            code-20:
              title: Sensor fault BT20 (exhaust air)
              description: >-
                Sensor not connected/defective (exhaust air). For ground source: FLM
                pump blocked. For exhaust air: automatic reset.
              severity: warning
            code-21:
              title: Sensor fault BT21 (extract air)
              description: >-
                Sensor not connected/defective (extract air). For ground source: FLM
                pump blocked. For exhaust air: automatic reset.
              severity: warning
            code-25:
              title: Sensor fault BT25
              description: >-
                Sensor not connected/defective (external heating medium return).
                External addition blocked.
              severity: warning
            code-26:
              title: Sensor fault BT26
              description: >-
                Sensor not connected/defective (brine, collector in). FLM pump
                blocked.
              severity: warning
            code-27:
              title: Sensor fault BP8
              description: >-
                Sensor not connected/defective (low pressure sensor). Compressor
                blocked.
              severity: critical
            code-28:
              title: Sensor fault BT71
              code-description: >-
                Sensor not connected/defective (external heating medium return).
                Together with alarm 25: heating is blocked.
              severity: warning
            code-29:
              title: Sensor fault BT29
              description: >-
                Sensor not connected/defective (compressor oil temperature).
                Compressor blocked.
              severity: critical
            code-31:
              title: Sensor fault BT63
              description: >-
                Sensor not connected/defective (heating medium supply after
                immersion heater). Internal electric addition blocked. Automatic
                reset.
              severity: warning
            code-32:
              title: Sensor fault BS1
              description: >-
                Air flow is out of range of the air velocity sensor. Compressor
                blocked; automatic reset.
              severity: warning
            code-40:
              title: Compressor phase 1 missing
              description: >-
                Compressor phase missing or below 160 V for more than 30 minutes.
                Compressor blocked.
              severity: critical
            code-41:
              title: Compressor phase 2 missing
              description: >-
                Compressor phase missing or below 160 V for more than 30 minutes.
                Compressor blocked.
              severity: critical
            code-42:
              title: Compressor phase 3 missing
              description: >-
                Compressor phase missing or below 160 V for more than 30 minutes.
                Compressor blocked.
              severity: critical
            code-43:
              title: Faulty phase sequence
              description: Phases are connected in wrong sequence. Compressor blocked.
              severity: critical
            code-44:
              title: Overheated softstart
              description: Fuses for the soft start card defective. Compressor blocked.
              severity: critical
            code-45:
              title: Phase fault
              description: Motor protection on single phase (e.g. Norway) probably triggered.
              severity: critical
            code-50:
              title: High pressure alarm
              description: >-
                High pressure switch has triggered repeatedly. Compressor blocked.
                Manual reset required.
              severity: critical
            code-54:
              title: Motor protection alarm
              description: Motor protection breaker has triggered.
              severity: critical
            code-55:
              title: Hot gas alarm
              description: >-
                Compressor stopped due to too high hot gas temperature. Compressor
                blocked. Manual reset required.
              severity: critical
            code-58:
              title: Pressure switch
              description: High or low pressure switch has triggered. Compressor blocked.
              severity: critical
            code-60:
              title: Low HTF out
              description: >-
                Outgoing brine below configured minimum temperature. Compressor
                blocked.
              severity: critical
            code-63:
              title: Low air flow
              description: Too low air flow at air flow sensor BS1. Compressor blocked.
              severity: critical
            code-64:
              title: Low exhaust air temperature
              description: >-
                Exhaust air temperature below 16°C and not above 17°C within 60
                minutes. Compressor blocked; auto reset after exhaust air >17°C for
                60 minutes.
              severity: warning
            code-65:
              title: High condensation water level (external)
              description: Alarm from external level monitor. Compressor blocked.
              severity: critical
            code-66:
              title: High condensation water level (internal)
              description: >-
                Alarm from level monitor in condensation water container. Compressor
                blocked.
              severity: critical
            code-67:
              title: Antifreeze protection supply air
              description: >-
                Supply air temperature below 5°C. Fans stop and compressor blocked;
                immersion heater block lifted.
              severity: critical
            code-70:
              title: Perm. com. error input card
              description: >-
                No communication with input card. Calculated flow set to minimum;
                manual reset required.
              severity: critical
            code-71:
              title: Perm. com. error base card
              description: >-
                No communication with base card. Compressor blocked; manual reset
                required.
              severity: critical
            code-72:
              title: Perm. com. error softstart card
              description: No communication with softstart card. Compressor blocked.
              severity: critical
            code-75:
              title: Perm. com. error base card
              description: >-
                No communication with base card AA26. Compressor blocked; manual
                reset required.
              severity: critical
            code-83:
              title: Unsuccessful defrosting
              description: >-
                Defrost stop conditions not met (F750/F110). Defrost discontinued;
                compressor and immersion heater stopped.
              severity: warning
            code-100:
              title: Perm. com. error inverter
              description: Permanent communication fault with inverter. Compressor blocked.
              severity: critical
            code-140:
              title: Compressor phase 1 missing (temporary)
              description: Phase 1 briefly missing.
              severity: warning
            code-141:
              title: Compressor phase 2 missing (temporary)
              description: Phase 2 briefly missing.
              severity: warning
            code-142:
              title: Compressor phase 3 missing (temporary)
              description: Phase 3 briefly missing.
              severity: warning
            code-150:
              title: High condenser out
              description: >-
                Condenser out has reached max permitted temperature. Automatic
                reset.
              severity: warning
            code-155:
              title: Hot gas alarm (temporary)
              description: >-
                Hot gas temperature (BT14) temporarily above 135°C. Compressor
                stopped; auto reset when below 90°C.
              severity: warning
            code-160:
              title: Low HTF out (temporary)
              description: Brine out has reached set minimum temperature. Automatic reset.
              severity: warning
            code-161:
              title: High HTF in
              description: Brine in has reached set maximum temperature. Automatic reset.
              severity: warning
            code-162:
              title: High condenser out (temporary)
              description: >-
                Condenser out has reached max permitted temperature. Automatic
                reset.
              severity: warning
            code-163:
              title: High condenser in
              description: Condenser exceeds max temperature.
              severity: warning
            code-170:
              title: Com. error input card
              description: Temporary communication error with input card.
              severity: warning
            code-171:
              title: Com. error base card
              description: Temporary communication error with base card.
              severity: warning
            code-172:
              title: Com. error softstart card
              description: Temporary communication error with softstart card.
              severity: warning
            code-180:
              title: Freeze protection active
              description: >-
                Outdoor temperature below 3°C while heating not permitted; freeze
                protection allows room heating.
              severity: info
            code-181:
              title: Failed periodic increase
              description: Periodic increase did not reach stop temperature within 5 hours.
              severity: warning
            code-182:
              title: Load monitor activated
              description: >-
                One or more power steps cannot be activated because phase current
                too high.
              severity: warning
            code-183:
              title: Defrosting
              description: Defrost in progress.
              severity: info
            code-184:
              title: Filter alarm
              description: Air filter needs cleaning.
              severity: info
            code-185:
              title: Anti-freeze supply air
              description: >-
                Supply air (BT22) or return from heating battery (BT69) below 5°C.
                Fans stopped, compressor blocked; immersion heater block lifted.
              severity: critical
            code-255:
              title: Motor protection alarm, brine pump
              description: >-
                Motor protection on brine pump triggered. Current compressor
                blocked; automatic reset.
              severity: critical
            code-261:
              title: "Heat pump alarm: temperature deviation"
              description: >-
                Temperature deviation on heat exchanger sensor 5 times within 60
                minutes or continuously for 60 minutes. Compressor blocked.
              severity: critical
            code-262:
              title: "Heat pump alarm: overheat power transistor"
              description: Overheated power transistor in inverter. Compressor blocked.
              severity: critical
            code-263:
              title: "Heat pump alarm: incorrect inverter voltage"
              description: Incorrect voltage out from inverter. Compressor blocked.
              severity: critical
            code-264:
              title: "Heat pump alarm: inverter communication"
              description: >-
                Communication between inverter circuit board and control card
                interrupted. Compressor blocked.
              severity: critical
            code-265:
              title: "Heat pump alarm: power transistor error"
              description: >-
                Continuous error on power transistor for 15 minutes. Compressor
                blocked.
              severity: critical
            code-266:
              title: "Heat pump alarm: low refrigerant amount"
              description: Low refrigerant amount detected. Compressor blocked.
              severity: critical
            code-290:
              title: Fan alarm
              description: >-
                Tachometer signal from fan indicates zero speed. Compressor,
                immersion heater and defrost stopped.
              severity: critical
            code-291:
              title: Charge pump alarm
              description: >-
                Tachometer signal from charge pump indicates zero speed. Compressor,
                immersion heater and defrost stopped.
              severity: critical
            code-340:
              title: Anti-freeze supply air
              description: >-
                Supply air temperature (BT22) below 11°C. HW load blocked; auto
                reset when supply air >16°C.
              severity: warning
            code-351:
              title: Uncertain sensor accuracy (BT10/BT11)
              description: >-
                More than 2 K difference between brine sensors BT10 and BT11 at
                calibration. GP2 switches to manual speed.
              severity: warning
            code-352:
              title: Uncertain sensor accuracy (BT2/BT3)
              description: >-
                More than 2 K difference between HM sensors BT2 and BT3 at
                calibration. GP1 switches to manual speed.
              severity: warning
            code-353:
              title: Uncertain sensor accuracy (BT3/BT12)
              description: >-
                More than 2 K difference between HM sensors BT3 and BT12 at
                calibration. GP1 switches to manual speed.
              severity: warning
            code-356:
              title: Failed sensor calibration
              description: >-
                Calibration difference more than 2 K between BT3 and BT63. GP1
                switches to manual operation.
              severity: warning
            code-403:
              title: Sensor fault on EB101
              description: >-
                Sensor fault detected on EB101 (MHI-EMMY). Compressor blocked;
                GP12/GP1 may switch to manual speed.
              severity: critical
            code-404:
              title: Sensor fault on EB101
              description: Sensor fault detected on EB101 (MHI-EMMY). Compressor blocked.
              severity: critical
            code-412:
              title: Sensor fault on EB101-BT12
              description: >-
                Sensor fault detected on EB101-BT12. Compressor blocked; pumps may
                switch to manual speed.
              severity: critical
            code-415:
              title: Sensor fault on EB101-BT15
              description: Sensor fault detected on EB101-BT15. Compressor blocked.
              severity: critical
            code-995:
              title: External alarm
              description: >-
                Alarm according to configuration on AUX input. Auto reset when
                contact closes.
              severity: warning
            code-996:
              title: Blocked external addition
              description: >-
                External additional heat blocked via AUX input. Auto reset when
                contact closes.
              severity: info
            code-997:
              title: Blocked external compressor
              description: >-
                External compressor block via AUX input. Auto reset when contact
                closes; compressor blocked while active.
              severity: warning
          key: code-{{ alarm_code | int }}
          result: |
            {{ alarms.get(
              key,
              {
                'title': 'Unknown alarm code',
                'description': 'No description available for ' ~ key,
                'severity': 'unknown'
              }
            ) }}
      - stop: Lookup done
        response_variable: result